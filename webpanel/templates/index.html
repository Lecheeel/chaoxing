{% extends "base.html" %}

{% block title %}首页 - 超星学习通自动签到系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt me-2 text-primary"></i>
                系统概览
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>刷新
                </button>
                <a href="{{ url_for('sign.manual') }}" class="btn btn-primary">
                    <i class="fas fa-hand-pointer me-1"></i>手动签到
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            今日签到成功
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="today-success-count">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            今日签到失败
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="today-failed-count">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            注册用户数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-users">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            系统状态
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span class="badge bg-success">正常运行</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-server fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快速操作和最近活动 -->
<div class="row">
    <!-- 快速操作 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-bolt me-2"></i>快速操作
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg" onclick="showBatchSignModal()">
                        <i class="fas fa-users me-2"></i>为所有用户签到
                    </button>
                    <button type="button" class="btn btn-warning btn-lg" onclick="refreshAllCookies()">
                        <i class="fas fa-sync me-2"></i>刷新全部Cookie
                    </button>
                    <div class="row">
                        <div class="col-6">
                            <a href="{{ url_for('user.add') }}" class="btn btn-info w-100">
                                <i class="fas fa-user-plus me-1"></i>添加用户
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('system.tasks') }}" class="btn btn-warning w-100">
                                <i class="fas fa-clock me-1"></i>定时任务
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近签到日志 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-history me-2"></i>最近签到日志
                </h6>
            </div>
            <div class="card-body">
                <div id="recent-logs" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 系统信息 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-info-circle me-2"></i>系统信息
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-muted">CPU使用率</h6>
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="cpu-usage">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-muted">内存使用率</h6>
                            <div class="progress">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="memory-usage">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-muted">磁盘使用率</h6>
                            <div class="progress">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="disk-usage">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-muted">运行时间</h6>
                            <p class="mb-0" id="uptime">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 批量签到模态框 -->
<div class="modal fade" id="batchSignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2 text-success"></i>
                    批量用户签到
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="batchSignLocation" class="form-label">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        签到位置
                    </label>
                    <select class="form-select" id="batchSignLocation" required>
                        <option value="">请选择签到位置</option>
                        <option value="default">默认位置（不推荐）</option>
                    </select>
                    <div class="form-text">选择用于批量签到的位置</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="executeBatchSign()">
                    <i class="fas fa-play me-1"></i>开始签到
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let locations = [];

$(document).ready(function() {
    loadDashboardData();
    loadRecentLogs();
    loadSystemInfo();
    loadLocations();
    
    // 每30秒刷新一次数据
    setInterval(function() {
        loadDashboardData();
        loadSystemInfo();
    }, 30000);
    
    // 每10秒刷新一次日志
    setInterval(loadRecentLogs, 10000);
});

function loadDashboardData() {
    $.get('/sign/api/sign_status')
        .done(function(response) {
            if (response.success) {
                $('#today-success-count').text(response.data.today_success);
                $('#today-failed-count').text(response.data.today_failed);
                $('#total-users').text(response.data.total_users);
            }
        })
        .fail(function() {
            $('#today-success-count').text('--');
            $('#today-failed-count').text('--');
            $('#total-users').text('--');
        });
}

function loadRecentLogs() {
    $.get('/system/api/logs?lines=10')
        .done(function(response) {
            if (response.success) {
                const logsHtml = response.data.map(log => 
                    `<div class="small text-muted mb-1">${log}</div>`
                ).join('');
                $('#recent-logs').html(logsHtml || '<div class="text-muted">暂无日志</div>');
            }
        })
        .fail(function() {
            $('#recent-logs').html('<div class="text-danger">加载日志失败</div>');
        });
}

function loadSystemInfo() {
    $.get('/system/api/system_info')
        .done(function(response) {
            if (response.success) {
                const data = response.data;
                $('#cpu-usage').css('width', data.cpu_percent + '%').text(data.cpu_percent + '%');
                $('#memory-usage').css('width', data.memory_percent + '%').text(data.memory_percent + '%');
                $('#disk-usage').css('width', data.disk_percent + '%').text(data.disk_percent + '%');
                $('#uptime').text(data.uptime);
            }
        })
        .fail(function() {
            $('#cpu-usage').css('width', '0%').text('--');
            $('#memory-usage').css('width', '0%').text('--');
            $('#disk-usage').css('width', '0%').text('--');
            $('#uptime').text('--');
        });
}

function refreshData() {
    loadDashboardData();
    loadRecentLogs();
    loadSystemInfo();
    showToast('数据已刷新', 'success');
}

// 加载位置列表
function loadLocations() {
    $.get('/system/api/locations')
        .done(function(response) {
            if (response.success) {
                locations = response.data;
                console.log('位置列表加载成功:', locations.length, '个位置');
                updateBatchSignLocationOptions();
            } else {
                console.error('加载位置列表失败:', response.message);
            }
        })
        .fail(function() {
            console.error('加载位置列表请求失败');
        });
}

// 更新批量签到位置选项
function updateBatchSignLocationOptions() {
    const select = $('#batchSignLocation');
    // 清空除第一个选项外的所有选项
    select.find('option:not(:first)').remove();
    
    // 添加默认位置选项
    select.append('<option value="default">默认位置（不推荐）</option>');
    
    // 添加已配置的位置
    if (locations && locations.length > 0) {
        locations.forEach(function(location) {
            select.append(`<option value="${location.id}" data-address="${location.address}">
                ${location.name} - ${location.address}
            </option>`);
        });
        
        // 自动选择第一个位置
        const firstLocationOption = select.find('option[value!=""][value!="default"]').first();
        if (firstLocationOption.length > 0) {
            firstLocationOption.prop('selected', true);
        }
    }
}

// 显示批量签到模态框
function showBatchSignModal() {
    // 确保位置列表已加载
    if (locations.length === 0) {
        loadLocations();
        // 等待位置加载完成
        setTimeout(function() {
            updateBatchSignLocationOptions();
            $('#batchSignModal').modal('show');
        }, 500);
    } else {
        updateBatchSignLocationOptions();
        $('#batchSignModal').modal('show');
    }
}

// 执行批量签到
async function executeBatchSign() {
    const locationId = $('#batchSignLocation').val();
    
    if (!locationId) {
        showToast('请选择签到位置', 'warning');
        return;
    }
    
    // 检查是否选择了默认位置
    if (locationId === 'default') {
        const confirmed = await confirmDialog('您选择了"默认位置"，这是一个不推荐的操作。\n\n默认位置可能导致签到失败或位置不准确。\n建议您选择已配置的具体位置。\n\n是否确认继续执行批量签到？', '确认批量签到');
        if (!confirmed) {
            return;
        }
    }
    
    const confirmed = await confirmDialog('确定要为所有用户执行签到吗？', '执行批量签到');
    if (!confirmed) {
        return;
    }
    
    $('#batchSignModal').modal('hide');
    showLoadingToast('正在执行批量签到...');
    
    $.ajax({
        url: '/sign/api/sign_all',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            location_id: locationId
        }),
        success: function(response) {
            hideLoadingToast();
            if (response.success) {
                // 统计成功和失败的数量
                let successCount = 0;
                let failedCount = 0;
                
                if (response.data && Array.isArray(response.data)) {
                    response.data.forEach(function(item) {
                        if (item.success) {
                            successCount++;
                        } else {
                            failedCount++;
                        }
                    });
                }
                
                // 显示详细的签到结果
                if (successCount > 0 && failedCount === 0) {
                    showToast(`批量签到完成：${successCount}个用户全部签到成功`, 'success');
                } else if (successCount > 0 && failedCount > 0) {
                    showToast(`批量签到完成：${successCount}个成功，${failedCount}个失败`, 'warning');
                } else if (failedCount > 0 && successCount === 0) {
                    showToast(`批量签到完成：${failedCount}个用户全部签到失败`, 'error');
                } else {
                    showToast('批量签到任务已执行', 'info');
                }
                
                loadDashboardData();
            } else {
                showToast('批量签到失败: ' + response.message, 'error');
            }
        },
        error: function() {
            hideLoadingToast();
            showToast('批量签到执行失败', 'error');
        }
    });
}

async function refreshAllCookies() {
    const confirmed = await confirmDialog('确定要刷新所有用户的Cookie吗？此操作将重新登录获取新的认证信息，可能需要较长时间。', '刷新Cookie');
    if (confirmed) {
        showLoadingToast('正在刷新全部Cookie...');
        
        $.ajax({
            url: '/user/api/refresh_all_cookies',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(response) {
                hideLoadingToast();
                if (response.success) {
                    showToast(`成功刷新 ${response.data.success_count || 0} 个用户的Cookie`, 'success');
                    if (response.data.failed_count > 0) {
                        showToast(`${response.data.failed_count} 个用户刷新失败`, 'warning');
                    }
                    loadDashboardData(); // 刷新统计数据
                } else {
                    showToast('全部刷新失败: ' + response.message, 'error');
                }
            },
            error: function() {
                hideLoadingToast();
                showToast('全部刷新Cookie失败', 'error');
            }
        });
    }
}
</script>
{% endblock %} 